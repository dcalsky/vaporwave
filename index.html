<!DOCTYPE html>
<meta charset="UTF-8">
<title>蒸 気 機 - 蒸汽波 - 虛擬信號風格化影像後期工具</title>
<link rel="stylesheet" href="document.css">
<meta name="viewport" content="width=device-width,user-scalable=0">
<div class="app">
	<div class="ctrl-box">

		<!--<label>-->
		<!--<input type="checkbox" v-model="showConfig">選項-->
		<!--</label>-->
		<div class="side-left-box">
			<h1>蒸 気 機</h1>
			<div class="config-list-box">
				<div class="global-config-list">
					<a v-for="_config in configs"
					   :class="{active:_config.name === config.name}"
					   @click="setConfig(_config)">
						<span v-text="_config.name"></span>
						<span class="cor vote" @click.stop.prevent="voteConfig(_config)"></span>
					</a>
				</div>
				<div class="user-config-list" v-if="userConfigs.length">
					<h4>個人預設</h4>
					<a v-for="_config in userConfigs"
					   :class="{active:_config.name === config.name}"
					   @click="setConfig(_config)">
						<span v-text="_config.name"></span>
						<span class="cor remove" @click.stop.prevent="removeUserConfig(_config)"></span>
					</a>
				</div>

			</div>
		</div>
		<div class="output">
			<img :src="src" v-if="src">
		</div>
		<div class="img-list">
			<img v-for="src,index in images"
			     crossOrigin="Anonymous"
			     :src="src"
			     @click="setImageAndDraw"
			     @load="index===0&&setImageAndDraw($event)">
		</div>
		<div class="side-right-box">
			<div class="btn-box">
				<label>
					<a class="btn big wire">打開圖像</a>
					<input type="file" @change="chooseFile">
				</label>
				<button @click="output()" class="btn big">導出圖像</button>
			</div>
			<div class="config" v-if="showConfig">
				<div class="group">
					<div class="body content">
						<h2>📹「蒸 気 機」</h2>
						<p>虛擬信號風格化影像後期工具。</p>
						<p>通過抽象虛擬信號影像展現過程中的各種可能性、實現了九十年代影像風格的重現。</p>
						<p>
							全做：<a href="https://weibo.com/reiove" target="_blank">@卜卜口</a>
							/
							反饋：<a href="https://github.com/itorr/vaporwave" target="_blank">GitHub</a>
						</p>
						<p>這是壹個尋找影像風格化手段的過程中整理出的產物，沒找到理想的工具所以自己整了個輪子。</p>
						<p>旨在通過 <b>參數化</b>、<b>可視化</b> 來提升影像風格化的摸索效率。</p>
						<p class="pink">
							<span class="line">點擊<b>打開圖像</b>即可使用本工具，</span>
							<span class="line">同時支持<b>拖拽</b>及<b>粘貼</b>圖片。</span>
						</p>
						<p class="pink">
							在本工具內打開的圖像不會上傳到服務器。<br>
							<del>根據 EXIF 旋轉圖像功能還沒寫。</del>
						</p>

						<p>大家在摸索到理想的畫面風格時，可以通過 <b class="line">提交成為公共預設</b> 功能分享預設給大家。</p>
						<p>預設名稱限制為 <b title="/^[\u0800-\u9fa5]+$/">四字中日文</b> ，提交的預設經審核通過即可顯示。</p>
						<p>
							如需高質量影像，可勾選
							<label><input type="checkbox" v-model="config.sizeOrigin">原始尺寸處理</label>
						</p>
						<p>有適合當樣圖的影像可以 <b>點這裏上傳</b> 授權我！</p>
						<p>
							有適合抽象的概念可以和我說，不壹定能做 🤔<br>
							有什麽建議都可以和我說，不壹定聽 😠
						</p>
						<p>
							← 最左面是公共預設列表，現在是我的壹些預設<br>
							↙ 網面下緣是樣圖列表，可以配合預設預覽風格<br>
							↓ 往下滾動是選項設置列表，最下可保存和分享
						</p>
					</div>
				</div>
				<div class="group">
					<div class="head">
						<h3>基礎設置</h3>
					</div>
					<div class="body">
						<div class="label-box">
							<div class="head">
								<b>畫面亮度</b>
								<span v-text="config.light"></span>
							</div>
							<input type="range" v-model.number="config.light"  min="0" max="4" step="0.01">
						</div>
						<div class="label-box">
							<div class="head">
								<b>畫面反差</b>
								<span v-text="config.contrast"></span>
							</div>
							<input type="range" v-model.number="config.contrast"  min="0" max="4" step="0.01">
						</div>
						<div class="label-box">
							<div class="head">
								<b>暗部褪色</b>
								<span v-text="config.darkFade"></span>
							</div>
							<input type="range" v-model.number="config.darkFade"  min="0" max="128" step="1">
						</div>
						<div class="label-box">
							<div class="head">
								<b>亮部褪色</b>
								<span v-text="config.brightFade"></span>
							</div>
							<input type="range" v-model.number="config.brightFade"  min="0" max="128" step="1">
						</div>
					</div>
				</div>
				<div class="group">
					<div class="head">
						<h3>顏色設置</h3>
					</div>
					<div class="body">
						<div class="label-box">
							<div class="head">
								<b>紫鮮艷度</b>
								<span v-text="config.vividU"></span>
							</div>
							<input type="range" v-model.number="config.vividU" min=".1" max="2" step="0.01">
						</div>
						<div class="label-box">
							<div class="head">
								<b>青鮮艷度</b>
								<span v-text="config.vividV"></span>
							</div>
							<input type="range" v-model.number="config.vividV" min=".1" max="2" step="0.01">
						</div>
						<div class="label-box">
							<div class="head">
								<b>紫色偏移</b>
								<span v-text="config.shiftU"></span>
							</div>
							<input type="range" v-model.number="config.shiftU" min="-200" max="200" step="1">
						</div>
						<div class="label-box">
							<div class="head">
								<b>青色偏移</b>
								<span v-text="config.shiftV"></span>
							</div>
							<input type="range" v-model.number="config.shiftV" min="-200" max="200" step="1">
						</div>
						<div class="label-box">
							<div class="head">
								<b>色彩斷層</b>
								<span v-text="config.level"></span>
							</div>
							<input type="range" v-model.number="config.level"  min="1" max="255" step="1">
						</div>

					</div>
				</div>
				<div class="group">
					<div class="head">
						<h3>效果設置</h3>
					</div>
					<div class="body">
						<div class="label-box">
							<div class="head">
								<b>橫向偏移</b>
								<span v-text="config.shiftX"></span>
							</div>
							<input type="range" v-model.number="config.shiftX" min="0" max="1000" step="1">
						</div>
						<div class="label-box">
							<div class="head">
								<b>縱向偏移</b>
								<span v-text="config.shiftY"></span>
							</div>
							<input type="range" v-model.number="config.shiftY" min="0" max="1000" step="1">
						</div>


						<div class="label-box">
							<div class="head">
								<b>信息置換</b>
								<span v-text="config.replace"></span>
							</div>
							<input type="range" v-model.number="config.replace" min="0" max="3" step="1">
						</div>
						<!--
						<div class="label-box">
							<div class="head">
								<b>信號偏移</b>
								<span v-text="config.yuv420Noise"></span>
							</div>
							<input type="range" v-model.number="config.yuv420Noise" min="1" max="2" step="0.01">
						</div>
						-->
						<!--<div class="label-box">-->
						<!--<div class="head">-->
						<!--<b>整倍偏移</b>-->
						<!--<span v-text="config.yuv420Noise"></span>-->
						<!--</div>-->
						<!--<input type="range" v-model.number="config.yuv420Noise" min="1" max="8" step="1">-->
						<!--</div>-->

						<div class="label-box">
							<div class="head">
								<b>像素合並</b>
								<span v-text="config.zoom"></span>
							</div>
							<input type="range" v-model.number="config.zoom"   min="1" max="20" step="0.01">
						</div>

						<div class="label-box">
							<div class="head">
								<b>隔行掃描</b>
								<span v-text="config.interlaced"></span>
							</div>
							<input type="range" v-model.number="config.interlaced" min="0" max="8" step="1">
						</div>



						<div class="label-box">
							<div class="head">
								<b>信號質量</b>
								<span v-text="config.quality"></span>
							</div>
							<input type="range" v-model.number="config.quality" min="0" max="1" step="0.05">
						</div>
						<div class="label-box">
							<div class="head">
								<b>信號噪聲</b>
								<span v-text="config.lightNoise"></span>
							</div>
							<input type="range" v-model.number="config.lightNoise" min="0" max="500" step="1">
						</div>
						<div class="label-box">
							<div class="head">
								<b>膠片顆粒</b>
								<span v-text="config.darkNoise"></span>
							</div>
							<input type="range" v-model.number="config.darkNoise" min="0" max="500" step="1">
						</div>
					</div>
				</div>

				<div class="group">
					<div class="head">
						<h3>變形設置</h3>
					</div>
					<div class="body">
						<div class="label-box" style="padding:0 0 6px 0;">
							<b>原始尺寸</b>

							<label>
								<input type="checkbox" v-model="config.sizeOrigin">原始尺寸處理（性能差）
							</label>
						</div>
						<div class="label-box" style="padding:10px 0;">
							<b>拉伸方案</b>
							<label>
								<input type="radio" v-model="config.fit" value="cover" :disabled="config.sizeOrigin">填充
							</label>
							<label>
								<input type="radio" v-model="config.fit" value="contain" :disabled="config.sizeOrigin">完整
							</label>
							<label>
								<input type="radio" v-model="config.fit" value="fill" :disabled="config.sizeOrigin">拉伸
							</label>
						</div>
						<div class="label-box">
							<div class="label-box">
								<div class="head">
									<b>比例變形</b>
									<span v-text="config.ratio"></span>
								</div>
								<input type="range" v-model.number="config.ratio"
								       min="0.5" max="2" step="0.1"
								       :disabled="config.fit==='fill'">
							</div>
						</div>
						<div class="label-box">
							<div class="head">
								<b>邊緣偏差</b>
								<span v-text="config.border"></span>
							</div>
							<input type="range" v-model.number="config.border" min="0" max="30" step="0.1">
						</div>
					</div>
				</div>

				<div class="group">
					<div class="head">
						<h3>其他設置</h3>
					</div>
					<div class="body">


						<div class="label-box" style="padding:4px 0;">
							<label>
								<input type="checkbox" v-model="config.sharpen">強調線條
							</label>
							<label>
								<input type="checkbox" v-model="config.snow">切斷信號
							</label>
							<label>
								<input type="checkbox" v-model="config.invertLight">顛倒黑白
							</label>
						</div>
						<!--
						<div class="label-box" style="padding:4px 0;">
							<label>
								<input type="checkbox" v-model="config.none">對比原圖
							</label>
						</div>
						-->
						<div class="label-box config-ctrl-box">
							<button @click="addConfig()" class="btn wire">創建個人預設</button>
							<button class="btn wire">提交成為公共預設</button>
						</div>
					</div>
				</div>
			</div>


		</div>
	</div>

</div>

<script src="https://cdn.bootcss.com/vue/2.6.11/vue.min.js"></script>
<script src="90s.js"></script>
<script src="configs.js"></script>
<script src="images.js"></script>
<script>

	const readFileToURL = (file,onOver)=>{
		var reader = new FileReader();
		reader.onload = ()=>{
			const src = reader.result;
			onOver(src);
		};
		reader.readAsDataURL(file);
	};

	const readFileAndSetIMGSrc = file=>{
		readFileToURL(file,src=>{
			const img = new Image();
			img.src = src;
			img.onload = ()=>{
				app.img = img;
				reDraw(img,app.config,src=>{
					app.src = src;
				});
			}
		});
	};

	const isImageRegex = /^image\/(jpeg|gif|png|bmp|webp)$/;

	document.addEventListener('paste',e=>{
		console.log(e.clipboardData,e.clipboardData.files);

		const clipboardData = e.clipboardData;
		if(clipboardData.items[0]){
			let file = clipboardData.items[0].getAsFile();

			if(file && isImageRegex.test(file.type)){
				return readFileAndSetIMGSrc(file);
			}
		}

		if(clipboardData.files.length){
			for(let i = 0;i<clipboardData.files.length;i++){
				if(isImageRegex.test(clipboardData.files[i].type)){
					console.log(clipboardData.files[i])
					readFileAndSetIMGSrc(clipboardData.files[i]);
				}
			}
		}
	});

	document.addEventListener('dragover',e=>{
		e.preventDefault();
	});
	document.addEventListener('drop',e=>{
		e.preventDefault();

		const file = e.dataTransfer.files[0];

		if(file && file.type.match(isImageRegex)){
			readFileAndSetIMGSrc(file);
		}
	});

	const _reDraw = (img,config,callback)=>{

		clearTimeout(reDraw.T);
		reDraw.T = setTimeout(()=>{
			reDraw(img,config,callback);
			app.saveData();
		},100);
	};

	const deepCopy = o=>JSON.parse(JSON.stringify(o));

	const defaultConfig = {

		zoom: 1,

		light: 1,
		contrast: 1,

		darkFade:0,
		brightFade:0,

		shiftX: 0,
		shiftY: 0,

		shiftU: 0,
		shiftV: 0,


		level: 4, //顏色斷層

		interlaced: 0, //隔行掃描
		interlacedStrong:1,

		replace:0,

		vividU : 1,
		vividV : 1,

		sizeOrigin: false,
		sharpen: true,
		invertLight: false,

		yuv420:true,
		yuv420Noise:1,

		snow:false,
		quality:0.6,
		damage:0,

		ratio:1,


		lightNoise:0, //明度噪聲
		darkNoise:0, //膠片噪聲

		fit:'cover',

		border:0,

		none:false,

	};



	const userConfigs = JSON.parse(localStorage.getItem('userConfigs')||'[]');

	const data = {
		src:'',
		img:null,
		showConfig:true,
		config:{
			...defaultConfig,
			...configs[0]
		},
		configs,
		userConfigs,
		images
	};

	const isKanjiRegex = /^[\u0800-\u9fa5]+$/;

	const app = new Vue({
		el:'.app',
		data,
		methods: {
			setConfig(config){
				this.config = deepCopy({
					...defaultConfig,
					...config
				});
				this.draw();
			},
			addConfig(){
				const name = prompt('輸入四字中日文濾鏡名（務必是四個中日文字）');
				if(!name){
					return;
				}
				if(!isKanjiRegex.test(name.trim())){
					return alert('這不是四字中日文，請檢查後重新提交');
				}

				const config = deepCopy(this.config);
				config.name = name;

				console.log(JSON.stringify(config,0,4));
				this.userConfigs.push(config);
				this.saveData();
			},
			removeUserConfig(config){
				if(confirm('確定刪除這條預設？刪除後不可恢復')){
					this.userConfigs.splice(this.userConfigs.indexOf(config),1);
				}
				this.saveData();
			},
			saveData(){
				localStorage.setItem('userConfigs',JSON.stringify(app.userConfigs));
			},
			_draw(){
				_reDraw(this.img,this.config,src=>{
					app.src = src;
				});
			},
			draw(){
				reDraw(this.img,this.config,src=>{
					app.src = src;
				});
			},
			setImageAndDraw(e){
				this.img = e.target;

				this.draw();
			},
			output(){
				const a = document.createElement('a');
				a.href = this.src;
				a.download = `[lab.magiconch.com][90s-time-machine]-${+Date.now()}.jpg`;
				a.click();
			},
			chooseFile(e){
				if(e.target.files.length){
					readFileAndSetIMGSrc(e.target.files[0]);
				}
			}
		},
		watch:{
			config:{
				deep:true,
				handler(){
					this._draw();
				}
			}
		}
	});

	const loadScript = (src,el) =>{
		el = document.createElement('script');
		el.src = src;
		document.body.appendChild(el);
	};

	setTimeout(()=>{
		loadScript('//s4.cnzz.com/z_stat.php?id=1278706389&web_id=1278706389');
	},400);
</script>
