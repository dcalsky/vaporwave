<!DOCTYPE html>
<meta charset="UTF-8">
<title>九十年代时光机</title>
<link rel="stylesheet" href="document.css">
<div class="app">
	<div class="ctrl-box">

		<!--<label>-->
			<!--<input type="checkbox" v-model="showConfig">选项-->
		<!--</label>-->
		<div class="side-left-box">
			<h1>九十年代时光机📹</h1>
			<div class="config-list">
				<a v-for="_config in configs"
				   :class="{active:_config.name === config.name}"
				   @click="setConfig(_config)" v-text="_config.name"></a>
				<div class="user-config-list" v-if="userConfigs.length">
					<h4>个人预设</h4>
					<a v-for="_config in userConfigs"
					   :class="{active:_config.name === config.name}"
					   @click="setConfig(_config)">
						<span v-text="_config.name"></span>
						<span class="remove" @click.stop.prevent="removeUserConfig(_config)"></span>
					</a>
				</div>

			</div>
		</div>
		<div class="output">
			<img :src="src" v-if="src">
		</div>
		<div class="side-right-box">
			<div class="config" v-if="showConfig">
				<div class="group">
					<div class="body content">
						<h2>📹「九十年代时光机」</h2>
						<p>虚拟信号风格化影像后期工具。</p>
						<p>通过抽象虚拟信号影像展现过程中的各种可能性、实现了九十年代影像风格的重现。</p>
						<p>
							全做：<a href="https://weibo.com/reiove" target="_blank">@卜卜口</a>
							/
							反馈：<a href="https://github.com/itorr/90s-time-machine/issues" target="_blank">GitHub</a>
						</p>
						<p>这是一个寻找影像风格化手段的过程中整理出的产物，没找到理想的工具所以自己整了个轮子。</p>
						<p>旨在通过 <b>参数化</b>、<b>可视化</b> 来提升影像风格化的摸索效率。</p>
						<p>大家在摸索到理想的画面风格时，可以通过 <b class="line">提交成为公共预设</b> 功能分享预设给大家。</p>
						<p>预设名称限制为 <b title="/^[\u0800-\u9fa5]+$/">四字中日文</b> ，提交的预设经审核通过即可显示。</p>
						<p>打开的图像不会上传到服务器。</p>
						<p>
							高影像质量需求，可开启
							<label><input type="checkbox" v-model="config.sizeOrigin">原始尺寸处理</label>
						</p>
					</div>
				</div>
				<div class="group">
					<div class="head">
						<h3>基础设置</h3>
					</div>
					<div class="body">
						<div class="label-box">
							<div class="head">
								<b>画面亮度</b>
								<span v-text="config.light"></span>
							</div>
							<input type="range" v-model.number="config.light"  min="0" max="4" step="0.01">
						</div>
						<div class="label-box">
							<div class="head">
								<b>画面反差</b>
								<span v-text="config.contrast"></span>
							</div>
							<input type="range" v-model.number="config.contrast"  min="0" max="4" step="0.01">
						</div>
						<div class="label-box">
							<div class="head">
								<b>暗部褪色</b>
								<span v-text="config.darkFade"></span>
							</div>
							<input type="range" v-model.number="config.darkFade"  min="0" max="128" step="1">
						</div>
						<div class="label-box">
							<div class="head">
								<b>亮部褪色</b>
								<span v-text="config.brightFade"></span>
							</div>
							<input type="range" v-model.number="config.brightFade"  min="0" max="128" step="1">
						</div>
					</div>
				</div>
				<div class="group">
					<div class="head">
						<h3>颜色设置</h3>
					</div>
					<div class="body">
						<div class="label-box">
							<div class="head">
								<b>紫鲜艳度</b>
								<span v-text="config.vividU"></span>
							</div>
							<input type="range" v-model.number="config.vividU" min=".1" max="2" step="0.01">
						</div>
						<div class="label-box">
							<div class="head">
								<b>青鲜艳度</b>
								<span v-text="config.vividV"></span>
							</div>
							<input type="range" v-model.number="config.vividV" min=".1" max="2" step="0.01">
						</div>
						<div class="label-box">
							<div class="head">
								<b>紫色偏移</b>
								<span v-text="config.shiftU"></span>
							</div>
							<input type="range" v-model.number="config.shiftU" min="-100" max="100" step="1">
						</div>
						<div class="label-box">
							<div class="head">
								<b>青色偏移</b>
								<span v-text="config.shiftV"></span>
							</div>
							<input type="range" v-model.number="config.shiftV" min="-100" max="100" step="1">
						</div>
						<div class="label-box">
							<div class="head">
								<b>色彩断层</b>
								<span v-text="config.level"></span>
							</div>
							<input type="range" v-model.number="config.level"  min="1" max="255" step="1">
						</div>

					</div>
				</div>
				<div class="group">
					<div class="head">
						<h3>效果设置</h3>
					</div>
					<div class="body">
						<div class="label-box">
							<div class="head">
								<b>横向偏移</b>
								<span v-text="config.shiftX"></span>
							</div>
							<input type="range" v-model.number="config.shiftX" min="0" max="1000" step="1">
						</div>
						<div class="label-box">
							<div class="head">
								<b>纵向偏移</b>
								<span v-text="config.shiftY"></span>
							</div>
							<input type="range" v-model.number="config.shiftY" min="0" max="1000" step="1">
						</div>


						<div class="label-box">
							<div class="head">
								<b>信息置换</b>
								<span v-text="config.replace"></span>
							</div>
							<input type="range" v-model.number="config.replace" min="0" max="3" step="1">
						</div>
						<!--
						<div class="label-box">
							<div class="head">
								<b>信号偏移</b>
								<span v-text="config.yuv420Noise"></span>
							</div>
							<input type="range" v-model.number="config.yuv420Noise" min="1" max="2" step="0.01">
						</div>
						-->
						<!--<div class="label-box">-->
							<!--<div class="head">-->
								<!--<b>整倍偏移</b>-->
								<!--<span v-text="config.yuv420Noise"></span>-->
							<!--</div>-->
							<!--<input type="range" v-model.number="config.yuv420Noise" min="1" max="8" step="1">-->
						<!--</div>-->

						<div class="label-box">
							<div class="head">
								<b>像素合并</b>
								<span v-text="config.zoom"></span>
							</div>
							<input type="range" v-model.number="config.zoom"   min="1" max="20" step="0.01">
						</div>

						<div class="label-box">
							<div class="head">
								<b>隔行扫描</b>
								<span v-text="config.interlaced"></span>
							</div>
							<input type="range" v-model.number="config.interlaced" min="0" max="8" step="1">
						</div>



						<div class="label-box">
							<div class="head">
								<b>信号质量</b>
								<span v-text="config.quality"></span>
							</div>
							<input type="range" v-model.number="config.quality" min="0" max="1" step="0.05">
						</div>
						<div class="label-box">
							<div class="head">
								<b>信号噪声</b>
								<span v-text="config.lightNoise"></span>
							</div>
							<input type="range" v-model.number="config.lightNoise" min="0" max="500" step="1">
						</div>
						<div class="label-box">
							<div class="head">
								<b>胶片颗粒</b>
								<span v-text="config.darkNoise"></span>
							</div>
							<input type="range" v-model.number="config.darkNoise" min="0" max="500" step="1">
						</div>
					</div>
				</div>

				<div class="group">
					<div class="head">
						<h3>变形设置</h3>
					</div>
					<div class="body">
						<div class="label-box" style="padding:0 0 6px 0;">
							<b>原始尺寸</b>

							<label>
								<input type="checkbox" v-model="config.sizeOrigin">原始尺寸处理（性能差）
							</label>
						</div>
						<div class="label-box" style="padding:10px 0;">
							<b>拉伸方案</b>
							<label>
								<input type="radio" v-model="config.fit" value="cover" :disabled="config.sizeOrigin">填充
							</label>
							<label>
								<input type="radio" v-model="config.fit" value="contain" :disabled="config.sizeOrigin">完整
							</label>
							<label>
								<input type="radio" v-model="config.fit" value="fill" :disabled="config.sizeOrigin">拉伸
							</label>
						</div>
						<div class="label-box">
							<div class="label-box">
								<div class="head">
									<b>比例变形</b>
									<span v-text="config.ratio"></span>
								</div>
								<input type="range" v-model.number="config.ratio"
								       min="0.5" max="2" step="0.1"
								       :disabled="config.fit==='fill'">
							</div>
						</div>
						<div class="label-box">
							<div class="head">
								<b>边缘偏差</b>
								<span v-text="config.border"></span>
							</div>
							<input type="range" v-model.number="config.border" min="0" max="10" step="0.1">
						</div>
					</div>
				</div>

				<div class="group">
					<div class="head">
						<h3>其他设置</h3>
					</div>
					<div class="body">


						<div class="label-box" style="padding:4px 0;">
							<label>
								<input type="checkbox" v-model="config.sharpen">强调线条
							</label>
							<label>
								<input type="checkbox" v-model="config.snow">切断信号
							</label>
							<label>
								<input type="checkbox" v-model="config.invertLight">颠倒黑白
							</label>
						</div>
						<!--
						<div class="label-box" style="padding:4px 0;">
							<label>
								<input type="checkbox" v-model="config.none">对比原图
							</label>
						</div>
						-->
						<div class="label-box config-ctrl-box">
							<button @click="addConfig()" class="btn wire">创建个人预设</button>
							<button class="btn wire">提交成为公共预设</button>
						</div>
					</div>
				</div>



			</div>

			<div class="btn-box">
				<label>
					<a class="btn big wire">打开图像</a>
					<input type="file" @change="chooseFile">
				</label>
				<button @click="output()" class="btn big">导出图像</button>
			</div>

		</div>
		<div class="img-list">
			<img v-for="src,index in images"
			     crossOrigin="Anonymous"
			     :src="src"
			     @click="setImageAndDraw"
			     @load="index===0&&setImageAndDraw($event)">
		</div>
	</div>

</div>

<script src="https://cdn.bootcss.com/vue/2.6.11/vue.min.js"></script>
<script src="90s.js"></script>
<script src="configs.js"></script>
<script src="images.js"></script>
<script>

	const readFileToURL = (file,onOver)=>{
		var reader = new FileReader();
		reader.onload = ()=>{
			const src = reader.result;
			onOver(src);
		};
		reader.readAsDataURL(file);
	};

	const readFileAndSetIMGSrc = file=>{
		readFileToURL(file,src=>{
			const img = new Image();
			img.src = src;
			img.onload = ()=>{
				app.img = img;
				reDraw(img,app.config,src=>{
					app.src = src;
				});
			}
		});
	};

	const isImageRegex = /^image\/(jpeg|gif|png|bmp|webp)$/;

	document.addEventListener('paste',e=>{
		console.log(e.clipboardData,e.clipboardData.files);

		const clipboardData = e.clipboardData;
		if(clipboardData.items[0]){
			let file = clipboardData.items[0].getAsFile();

			if(file && isImageRegex.test(file.type)){
				return readFileAndSetIMGSrc(file);
			}
		}

		if(clipboardData.files.length){
			for(let i = 0;i<clipboardData.files.length;i++){
				if(isImageRegex.test(clipboardData.files[i].type)){
					console.log(clipboardData.files[i])
					readFileAndSetIMGSrc(clipboardData.files[i]);
				}
			}
		}
	});

	document.addEventListener('dragover',e=>{
		e.preventDefault();
	});
	document.addEventListener('drop',e=>{
		e.preventDefault();

		const file = e.dataTransfer.files[0];

		if(file && file.type.match(isImageRegex)){
			readFileAndSetIMGSrc(file);
		}
	});

	const _reDraw = (img,config,callback)=>{

		clearTimeout(reDraw.T);
		reDraw.T = setTimeout(()=>{
			reDraw(img,config,callback);
			app.saveData();
		},100);
	};

	const deepCopy = o=>JSON.parse(JSON.stringify(o));

	const defaultConfig = {

		zoom: 1,

		light: 1,
		contrast: 1,

		darkFade:0,
		brightFade:0,

		shiftX: 0,
		shiftY: 0,

		shiftU: 0,
		shiftV: 0,


		level: 4, //颜色断层

		interlaced: 0, //隔行扫描
		interlacedStrong:1,

		replace:0,

		vividU : 1,
		vividV : 1,

		sizeOrigin: false,
		sharpen: true,
		invertLight: false,

		yuv420:true,
		yuv420Noise:1,

		snow:false,
		quality:0.6,
		damage:0,

		ratio:1,


		lightNoise:0, //明度噪声
		darkNoise:0, //胶片噪声

		fit:'cover',

		border:0,

		none:false,

	};



	const userConfigs = JSON.parse(localStorage.getItem('userConfigs')||'[]');

	const data = {
		src:'',
		img:null,
		showConfig:true,
		config:{
			...defaultConfig,
			...configs[0]
		},
		configs,
		userConfigs,
		images
	};

	const isKanjiRegex = /^[\u0800-\u9fa5]+$/;

	const app = new Vue({
		el:'.app',
		data,
		methods: {
			setConfig(config){
				this.config = deepCopy({
					...defaultConfig,
					...config
				});
				this.draw();
			},
			addConfig(){
				const name = prompt('输入四字中日文滤镜名（务必是四个中日文字）');
				if(!name){
					return;
				}
				if(!isKanjiRegex.test(name.trim())){
					return alert('这不是四字中日文，请检查后重新提交');
				}

				const config = deepCopy(this.config);
				config.name = name;

				console.log(JSON.stringify(config,0,4));
				this.userConfigs.push(config);
				this.saveData();
			},
			removeUserConfig(config){
				if(confirm('确定删除这条预设？删除后不可恢复')){
					this.userConfigs.splice(this.userConfigs.indexOf(config),1);
				}
				this.saveData();
			},
			saveData(){
				localStorage.setItem('userConfigs',JSON.stringify(app.userConfigs));
			},
			_draw(){
				_reDraw(this.img,this.config,src=>{
					app.src = src;
				});
			},
			draw(){
				reDraw(this.img,this.config,src=>{
					app.src = src;
				});
			},
			setImageAndDraw(e){
				this.img = e.target;

				this.draw();
			},
			output(){
				const a = document.createElement('a');
				a.href = this.src;
				a.download = `[lab.magiconch.com][90s-time-machine]-${+Date.now()}.jpg`;
				a.click();
			},
			chooseFile(e){
				if(e.target.files.length){
					readFileAndSetIMGSrc(e.target.files[0]);
				}
			}
		},
		watch:{
			config:{
				deep:true,
				handler(){
					this._draw();
				}
			}
		}
	});
</script>
